<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger - Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4e5bf2;
            --primary-gradient: linear-gradient(135deg, #4e5bf2 0%, #2938cf 100%);
            --bg-body: #f4f6f8;
            --bg-white: #ffffff;
            --text-dark: #121212;
            --text-gray: #889096;
            --border-light: #eff1f3;
            --own-msg-bg: #4e5bf2;
            --other-msg-bg: #f5f7f9;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
            --radius-xl: 16px;
        }

        body { 
            margin: 0; 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--bg-body); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            color: var(--text-dark);
        }
        
        /* Navbar */
        .navbar { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            height: 70px; 
            padding: 0 40px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-shrink: 0; 
            border-bottom: 1px solid var(--border-light);
        }
        .nav-logo { 
            font-size: 26px; 
            font-weight: 800; 
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none; 
            letter-spacing: -0.5px;
        }
        .nav-icons { display: flex; gap: 15px; }
        .nav-icon { 
            width: 45px; 
            height: 45px; 
            background: #fff; 
            border: 1px solid var(--border-light);
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-decoration: none; 
            color: var(--text-dark); 
            font-size: 22px; 
            transition: all 0.3s ease;
        }
        .nav-icon:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(78, 91, 242, 0.15); 
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Layout */
        .chat-container { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            max-width: 1600px; 
            margin: 20px auto; 
            width: 95%; 
            background: var(--bg-white); 
            box-shadow: var(--shadow-soft); 
            border-radius: 24px;
        }

        /* Sidebar */
        .chat-sidebar { 
            width: 380px; 
            background: white;
            border-right: 1px solid var(--border-light); 
            display: flex; 
            flex-direction: column; 
        }
        .chat-header { 
            padding: 30px 25px 20px 25px; 
            font-size: 28px; 
            font-weight: 800; 
            letter-spacing: -0.5px;
        }
        .chat-search { padding: 0 25px 20px 25px; }
        .chat-search input { 
            width: 100%; 
            padding: 15px 20px; 
            border-radius: 14px; 
            border: 1px solid var(--border-light); 
            background: #fcfdfe; 
            outline: none; 
            box-sizing: border-box; 
            font-family: inherit;
            font-size: 15px;
            transition: 0.2s;
        }
        .chat-search input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(78, 91, 242, 0.05);
        }
        
        .user-list { 
            overflow-y: auto; 
            flex: 1; 
            padding: 0 15px 15px 15px; 
        }
        .user-item { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 15px; 
            border-radius: 16px; 
            text-decoration: none; 
            color: var(--text-dark); 
            transition: all 0.2s; 
            margin-bottom: 5px; 
            border: 1px solid transparent;
        }
        .user-item:hover { 
            background: #f8faff; 
            transform: translateX(5px);
        }
        .user-item.active { 
            background: #eff2fe; 
            border-color: rgba(78, 91, 242, 0.1);
        }
        
        .avatar-wrapper { position: relative; width: 50px; height: 50px; flex-shrink: 0; }
        .avatar-img { 
            width: 100%; 
            height: 100%; 
            border-radius: 16px; 
            object-fit: cover; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        /* Chat Main */
        .chat-main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: #fff; 
            position: relative;
        }
        
        .chat-topbar { 
            padding: 20px 30px; 
            border-bottom: 1px solid var(--border-light); 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            z-index: 10;
        }
        .chat-topbar h3 { margin: 0; font-size: 18px; font-weight: 700; }
        
        .messages-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            background-image: radial-gradient(#eff2fe 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .message-bubble { 
            max-width: 65%; 
            padding: 12px 18px; 
            border-radius: 20px; 
            position: relative; 
            word-wrap: break-word; 
            font-size: 15px; 
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        
        .msg-own { 
            align-self: flex-end; 
            background: var(--primary-gradient); 
            color: white; 
            border-bottom-right-radius: 4px; 
            box-shadow: 0 4px 15px rgba(78, 91, 242, 0.2);
        }
        .msg-other { 
            align-self: flex-start; 
            background-color: var(--other-msg-bg); 
            color: var(--text-dark); 
            border-bottom-left-radius: 4px; 
        }
        
        .msg-meta { 
            font-size: 11px; 
            margin-top: 5px; 
            opacity: 0.8; 
            display: flex; 
            justify-content: flex-end; 
            align-items: center;
            gap: 8px; 
        }
        
        /* Input Area */
        .input-area { 
            padding: 25px; 
            border-top: 1px solid var(--border-light); 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            background: white;
        }
        .input-field { 
            flex: 1; 
            padding: 16px 25px; 
            border-radius: 30px; 
            border: 2px solid var(--border-light); 
            background: #fbfbfb; 
            outline: none; 
            font-size: 15px; 
            font-family: inherit;
            transition: all 0.3s;
        }
        .input-field:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 5px rgba(78, 91, 242, 0.05);
        }
        .btn-send { 
            background: var(--primary-gradient); 
            border: none; 
            color: white; 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 15px; 
            padding: 0 25px; 
            height: 54px;
            border-radius: 27px;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(78, 91, 242, 0.25);
        }
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 91, 242, 0.35);
        }
        
        /* Actions */
        .delete-btn { font-size: 10px; cursor: pointer; opacity: 0.7; color: white; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; border:none; }
        .delete-btn:hover { background: rgba(255,255,255,0.4); }
        
        .reaction-btn { background: none; border: none; cursor: pointer; font-size: 14px; padding: 0 4px; transition: 0.2s; opacity: 0.8; }
        .reaction-btn:hover { transform: scale(1.3); opacity: 1; }
        .reaction-btn.active { transform: scale(1.2); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #dce0e5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #c5c9d0; }

        /* Emoji Picker */
        #emojiPicker {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            padding: 10px 20px;
            font-size: 13px;
            color: #889096;
            font-style: italic;
            align-items: center;
            gap: 5px;
        }
        .dot-typing {
            position: relative;
            left: -9999px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #889096;
            color: #889096;
            box-shadow: 9984px 0 0 0 #889096, 9999px 0 0 0 #889096, 10014px 0 0 0 #889096;
            animation: dot-typing 1.5s infinite linear;
        }
        @keyframes dot-typing {
            0% { box-shadow: 9984px 0 0 0 #889096, 9999px 0 0 0 #889096, 10014px 0 0 0 #889096; }
            16.667% { box-shadow: 9984px -5px 0 0 #889096, 9999px 0 0 0 #889096, 10014px 0 0 0 #889096; }
            33.333% { box-shadow: 9984px 0 0 0 #889096, 9999px -5px 0 0 #889096, 10014px 0 0 0 #889096; }
            50% { box-shadow: 9984px 0 0 0 #889096, 9999px 0 0 0 #889096, 10014px -5px 0 0 #889096; }
            66.667% { box-shadow: 9984px 0 0 0 #889096, 9999px 0 0 0 #889096, 10014px 0 0 0 #889096; }
            83.333% { box-shadow: 9984px 0 0 0 #889096, 9999px 0 0 0 #889096, 10014px 0 0 0 #889096; }
            100% { box-shadow: 9984px 0 0 0 #889096, 9999px 0 0 0 #889096, 10014px 0 0 0 #889096; }
        }
        .video-call-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .video-container {
            position: relative;
            width: 80%;
            max-width: 1000px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(78, 91, 242, 0.3);
        }

        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            aspect-ratio: 16/9;
            background: #333;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            object-fit: cover;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: 0.3s;
        }
        
        .call-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            background: rgba(0,0,0,0.6);
            padding: 15px 30px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .control-btn.end-call { background: #ff4757; }
        .control-btn.end-call:hover { background: #ff6b81; }

        /* Incoming Call Modal */
        .incoming-call-modal {
            display: none;
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            background: rgba(25, 30, 40, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1001;
            color: white;
            align-items: center;
            gap: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .incoming-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }
        .incoming-actions { display: flex; gap: 15px; }
        .action-btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-accept { background: #2ecc71; color: white; }
        .btn-decline { background: #ff4757; color: white; }
        .btn-accept:hover { transform: scale(1.05); }
        .btn-decline:hover { transform: scale(1.05); }

    </style>
</head>
<body>

    <div class="navbar">
        <a href="/dashboard" class="nav-logo" style="display: flex; align-items: center; gap: 2px;">
            <span style="color: #ff4757; font-weight: 800;">Bta</span>SocialPortal
        </a>
        <div class="nav-icons">
            <a href="/dashboard" class="nav-icon" title="Home">üè†</a>
            <a href="/friends" class="nav-icon" title="Friends" style="position:relative;">
                üë•
                <% if (typeof friendRequestsCount !== 'undefined' && friendRequestsCount > 0) { %>
                    <span style="position: absolute; top: -5px; right: -5px; background: #e41e3f; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; border: 2px solid white;">+<%= friendRequestsCount %></span>
                <% } %>
            </a>
            <a href="/chat" class="nav-icon" title="Messenger" style="background:var(--primary); color:white; border-color:var(--primary);">üí¨</a>
            <a href="/settings" class="nav-icon" title="Settings">‚öôÔ∏è</a>
        </div>
    </div>

    <div class="chat-container">
        
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="chat-header">Chats</div>
            <div class="chat-search">
                <input type="text" placeholder="Search Messenger..." id="searchInput">
            </div>
            
            <div style="padding: 0 25px 15px 25px; display:flex; gap:10px;">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="friends">Friends</button>
            </div>
            
            <style>
                .filter-btn {
                    padding: 8px 16px;
                    border-radius: 20px;
                    border: 1px solid var(--border-light);
                    background: white;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 600;
                    color: var(--text-gray);
                    transition: all 0.2s;
                    font-family: inherit;
                }
                .filter-btn.active {
                    background: var(--primary);
                    color: white;
                    border-color: var(--primary);
                }
                .filter-btn:hover:not(.active) {
                    background: #f8faff;
                }
            </style>
            
            <div class="user-list">
                <a href="/chat?with=global" class="user-item <%= activeChatPartner === 'global' ? 'active' : '' %>">
                    <div class="avatar-wrapper">
                        <div style="width:100%; height:100%; border-radius:16px; background:var(--primary-gradient); color:white; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow: 0 4px 10px rgba(78, 91, 242, 0.3);">üåê</div>
                    </div>
                    <div>
                        <div style="font-weight:700; font-size: 16px;">Global Chat</div>
                        <div style="font-size:13px; color:var(--text-gray);">Public Room</div>
                    </div>
                </a>

                <% users.forEach(u => { %>
                    <% if (u.email !== currentUser.email) { %>
                        <a href="/chat?with=<%= u.email %>" class="user-item <%= activeChatPartner === u.email ? 'active' : '' %>" data-email="<%= u.email %>">
                            <div class="avatar-wrapper">
                                <img src="<%= u.avatar %>" class="avatar-img">
                            </div>
                            <div>
                                <div style="font-weight:600; font-size: 15px;"><%= u.firstName %> <%= u.lastName %></div>
                                <div style="font-size:13px; color:var(--text-gray);">@<%= u.username %></div>
                            </div>
                        </a>
                    <% } %>
                <% }) %>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-main">
            <div class="chat-topbar">
                <% if (activeChatPartner === 'global') { %>
                    <div style="width:45px; height:45px; border-radius:14px; background:var(--primary-gradient); color:white; display:flex; align-items:center; justify-content:center; font-size:20px;">üåê</div>
                    <div>
                        <h3 style="margin-bottom:2px;">Global Chat</h3>
                        <div style="font-size:12px; color:var(--text-gray);">Online</div>
                    </div>
                <% } else { 
                    const partner = users.find(u => u.email === activeChatPartner);
                %>
                    <img src="<%= partner ? partner.avatar : '/uploads/default.png' %>" style="width:45px; height:45px; border-radius:14px; object-fit:cover;">
                    <div>
                        <h3 style="margin-bottom:2px;"><%= partner ? partner.firstName + ' ' + partner.lastName : activeChatPartner %></h3>
                        <div style="font-size:12px; color:var(--text-gray);">Active Now</div>
                    </div>
                    <div style="margin-left: auto;">
                        <button onclick="startCall()" class="nav-icon" style="border:none; background:var(--bg-body); cursor:pointer; color:var(--primary);" title="Video Call">
                            üìπ
                        </button>
                    </div>
                <% } %>
            </div>

            <!-- Video Call Modals -->
            <div class="video-call-modal" id="videoModal">
                <div class="video-container">
                    <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
                    <video id="localVideo" class="local-video" autoplay playsinline muted></video>
                    
                    <div class="call-controls">
                        <button class="control-btn" id="muteBtn" onclick="toggleMute()">üé§</button>
                        <button class="control-btn" id="cameraBtn" onclick="toggleCamera()">üì∑</button>
                        <button class="control-btn end-call" onclick="endCall()">üìû</button>
                    </div>
                </div>
                <div style="color:white; margin-top:20px; font-size:18px;" id="callStatusText">Calling...</div>
            </div>

            <div class="incoming-call-modal" id="incomingModal">
                <img src="/uploads/default.png" class="incoming-avatar" id="incomingAvatar">
                <div>
                    <div style="font-size:14px; opacity:0.7;">Incoming Video Call</div>
                    <div style="font-size:18px; font-weight:600;" id="incomingCallerName">User</div>
                </div>
                <div class="incoming-actions">
                    <button class="action-btn btn-decline" onclick="rejectCall()">Decline</button>
                    <button class="action-btn btn-accept" onclick="acceptCall()">Accept</button>
                </div>
            </div>


            <div class="messages-area" id="msgArea">
                <% messages.forEach(msg => { %>
                    <div class="message-bubble <%= msg.sender === currentUser.email ? 'msg-own' : 'msg-other' %>">
                        <% if (activeChatPartner === 'global' && msg.sender !== currentUser.email) { %>
                            <div style="font-size:11px; font-weight:700; margin-bottom:4px; color: var(--primary);"><%= msg.username %></div>
                        <% } %>
                        
                        <%= msg.message %>
                        
                        <div class="msg-meta">
                            <%= msg.timestamp %>
                            
                            <!-- Reaction Logic -->
                            <% 
                                const hasReacted = msg.reactions && msg.reactions.includes(currentUser.email);
                                const reactionCount = msg.reactions ? msg.reactions.length : 0;
                            %>
                            <form action="/chat/react/<%= msg.id %>" method="POST" style="display:inline;">
                                <input type="hidden" name="receiver" value="<%= activeChatPartner %>">
                                <button type="submit" class="reaction-btn <%= hasReacted ? 'active' : '' %>" title="Love">
                                    <%= hasReacted ? '‚ù§Ô∏è' : 'ü§ç' %> <span style="font-size: 10px;"><%= reactionCount > 0 ? reactionCount : '' %></span>
                                </button>
                            </form>

                            <% if (msg.sender === currentUser.email) { %>
                                <form action="/chat/delete/<%= msg.id %>" method="POST" style="display:inline;">
                                    <input type="hidden" name="receiver" value="<%= activeChatPartner %>">
                                    <button type="submit" class="delete-btn">üóëÔ∏è</button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                <% }) %>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                 <span>User is typing</span>
                 <div class="dot-typing" style="margin-left: 20px;"></div>
            </div>

            <div class="input-area" style="position:relative;">
                <div id="emojiPicker" style="display:none; position:absolute; bottom:90px; left:25px; background:white; border:1px solid #eee; padding:15px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.1); width:280px; flex-wrap:wrap; gap:8px;">
                    <!-- Emojis injected by JS -->
                </div>
                
                <button type="button" id="emojiBtn" style="background:none; border:none; font-size:24px; cursor:pointer; color:#889096; transition:0.2s;" title="Emoji">üòä</button>
                
                <form action="/chat/send" method="POST" style="display:flex; width:100%; gap:15px; align-items:center;">
                    <input type="hidden" name="receiver" value="<%= activeChatPartner %>">
                    <input type="text" name="message" id="msgInput" class="input-field" placeholder="Write a message..." autocomplete="off" autofocus>
                    <button type="submit" class="btn-send">Send</button>
                </form>
            </div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Auto scroll to bottom with smooth behavior
        const msgArea = document.getElementById('msgArea');
        msgArea.scrollTop = msgArea.scrollHeight;

         // Socket.io: Listen for incoming messages
        socket.on('chat message', (msg) => {
            const currentPartner = "<%= activeChatPartner %>"; 
            const currentUser = "<%= currentUser.email %>";
            
             if (msg.receiver === 'global' && currentPartner === 'global') {
                 location.reload(); 
             } else if ( (msg.sender === currentPartner && msg.receiver === currentUser) || 
                         (msg.sender === currentUser && msg.receiver === currentPartner) ) {
                 location.reload();
             }
        });

        // Typing Events
        let typingTimeout;
        const msgInput = document.getElementById('msgInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const activePartner = "<%= activeChatPartner %>";
        const myEmail = "<%= currentUser.email %>";

        msgInput.addEventListener('input', () => {
             if (activePartner === 'global') return; // No typing indicator for global yet
             
             socket.emit('typing', { toEmail: activePartner, fromEmail: myEmail });
             
             clearTimeout(typingTimeout);
             typingTimeout = setTimeout(() => {
                 socket.emit('stop_typing', { toEmail: activePartner, fromEmail: myEmail });
             }, 1000);
        });

        socket.on('typing', (data) => {
            if (data.fromEmail === activePartner) {
                typingIndicator.style.display = 'flex';
                // Auto hide after 3 seconds just in case stop event is missed
                 setTimeout(() => {
                    typingIndicator.style.display = 'none';
                 }, 3000);
            }
        });

        socket.on('stop_typing', (data) => {
            if (data.fromEmail === activePartner) {
                typingIndicator.style.display = 'none';
            }
        });

        // Emoji Picker Logic
        const emojis = ['üòÄ','üòÇ','ü•∞','üòç','üòé','üò≠','üò°','üëç','üëé','‚ù§Ô∏è','üî•','üéâ','üëã','üôè','üá¨üá™','üá∫üá∏','üöÄ','üíª','üì±','üçî'];
        const picker = document.getElementById('emojiPicker');
        const input = document.getElementById('msgInput');
        
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.textContent = emoji;
            span.style.cursor = 'pointer';
            span.style.fontSize = '24px';
            span.style.padding = '5px';
            span.style.transition = '0.2s';
            span.onmouseover = () => span.style.transform = 'scale(1.2)';
            span.onmouseout = () => span.style.transform = 'scale(1)';
            span.onclick = () => {
                input.value += emoji;
                input.focus();
            };
            picker.appendChild(span);
        });

        const emojiBtn = document.getElementById('emojiBtn');
        emojiBtn.onclick = () => {
             picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
             emojiBtn.style.color = picker.style.display === 'flex' ? '#4e5bf2' : '#889096';
        };

        // Close picker if clicked outside
        window.onclick = (e) => {
            if (!emojiBtn.contains(e.target) && !picker.contains(e.target)) {
                picker.style.display = 'none';
                emojiBtn.style.color = '#889096';
            }
        };

        // Filter Logic
        const friendsList = <%- JSON.stringify(locals.friendsList || []) %>;
        const filterBtns = document.querySelectorAll('.filter-btn');
        const userItems = document.querySelectorAll('.user-item');
        const searchInput = document.getElementById('searchInput');

        function filterUsers() {
            const filterType = document.querySelector('.filter-btn.active').dataset.filter;
            const query = searchInput.value.toLowerCase();

            userItems.forEach(item => {
                const email = item.dataset.email;
                if (!email) return; // Skip Global/Header items if any

                const nameText = item.querySelector('div[style*="font-weight:600"]').textContent.toLowerCase();
                const matchesSearch = nameText.includes(query);
                
                let matchesFilter = true;
                if (filterType === 'friends') {
                    matchesFilter = friendsList.includes(email);
                }

                item.style.display = (matchesSearch && matchesFilter) ? 'flex' : 'none';
            });
        }

        filterBtns.forEach(btn => {
            btn.onclick = () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filterUsers();
            };
        });

        searchInput.onkeyup = filterUsers;

        // --- WebRTC Logic ---
        
        let localStream;
        let remoteStream;
        let peerConnection;
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };
        
        const videoModal = document.getElementById('videoModal');
        const incomingModal = document.getElementById('incomingModal');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const callStatusText = document.getElementById('callStatusText');

        let isCaller = false;
        let currentCallSocketId = null;

        // Start Call (Caller Side)
        async function startCall() {
            const partnerEmail = "<%= activeChatPartner %>";
            if (partnerEmail === 'global') return alert("Cannot call in global chat");

            videoModal.style.display = 'flex';
            callStatusText.textContent = "Calling...";
            isCaller = true;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;

                socket.emit("call-user", {
                    to: partnerEmail,
                    offer: null, // Will generate after creating peer connection
                    callerName: "<%= currentUser.firstName %> <%= currentUser.lastName %>",
                    callerEmail: "<%= currentUser.email %>"
                });

                createPeerConnection();

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                socket.emit("call-user", {
                    to: partnerEmail,
                    offer: offer,
                    callerName: "<%= currentUser.firstName %> <%= currentUser.lastName %>",
                    callerEmail: "<%= currentUser.email %>"
                });

            } catch (err) {
                console.error("Error starting call:", err);
                alert("Could not access camera/microphone");
                closeModal();
            }
        }

        // Handle Incoming Call
        let incomingOffer = null;
        let incomingSocketId = null;

        socket.on("call-made", async (data) => {
            // Only accept if we are not already in a call? 
            // For now, let's just show the modal
            incomingOffer = data.offer;
            incomingSocketId = data.socket;
            
            document.getElementById('incomingCallerName').textContent = data.callerName;
            incomingModal.style.display = 'flex';
            
            // Should probably play a ringtone here
        });

        async function acceptCall() {
            incomingModal.style.display = 'none';
            videoModal.style.display = 'flex';
            callStatusText.textContent = "Connecting...";
            isCaller = false;
            currentCallSocketId = incomingSocketId;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;

                createPeerConnection();
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingOffer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.emit("make-answer", {
                    to: incomingSocketId,
                    answer: answer
                });

            } catch (err) {
                console.error("Error accepting call:", err);
                endCall();
            }
        }

        function rejectCall() {
            incomingModal.style.display = 'none';
            if (incomingSocketId) {
                socket.emit("reject-call", { toSocket: incomingSocketId });
            }
        }

        socket.on("answer-made", async (data) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            callStatusText.textContent = "Connected";
            currentCallSocketId = data.socket;
        });

        socket.on("call-rejected", () => {
            alert("User rejected the call");
            endCall();
        });

        socket.on("call-ended", () => {
            endCall();
        });

        socket.on("ice-candidate", async (data) => {
            if (peerConnection) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (e) {
                    console.error("Error adding ice candidate:", e);
                }
            }
        });

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // Send candidate to remote
                    if (isCaller) {
                        // We need to know who we are calling. 
                        // In simple setup we might need to store the target socket ID or email properly.
                        // For caller, we know 'activeChatPartner' is the target email.
                        // Ideally we send to specific socket ID if handshake established, but email works via relay
                         socket.emit("ice-candidate", {
                            toEmail: "<%= activeChatPartner %>", // Initially we use email
                            to: currentCallSocketId, // If we have it
                            candidate: event.candidate
                        });
                    } else {
                        socket.emit("ice-candidate", {
                            to: currentCallSocketId,
                            candidate: event.candidate
                        });
                    }
                }
            };

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            videoModal.style.display = 'none';
            
            // Notify other peer
            const partnerEmail = "<%= activeChatPartner %>";
            if (partnerEmail !== 'global' && isCaller) {
                 socket.emit("end-call", { to: partnerEmail });
            } else if (currentCallSocketId) {
                 socket.emit("end-call", { toSocket: currentCallSocketId }); // Need to handle toSocket in server if used
                 // Or just use the email logic from server side for simplicity
                 // Let's rely on the server map for simplicity if we can
            }
             // Actually, if we are the callee, we know currentCallSocketId is the caller.
             // If we are caller, we need to signal the callee.
             
             // Simplification: Just emit end-call with email context if possible or socket
             if (currentCallSocketId) {
                  // We can't really emit to socket directly from client unless we wrapped it in an event
                  // Re-use logic:
                  // For now, let's just close locally. The partner will likely detect disconnect or we send signal.
             }
        }

        function toggleMute() {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('muteBtn').textContent = audioTrack.enabled ? 'üé§' : 'üîá';
            }
        }

        function toggleCamera() {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('cameraBtn').textContent = videoTrack.enabled ? 'üì∑' : 'üö´';
            }
        }

    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; color: #050505; }
        
        /* Navbar */
        .navbar { background: white; height: 60px; padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .nav-logo { font-size: 24px; font-weight: bold; color: #1877f2; text-decoration: none; }
        .nav-search input { background: #f0f2f5; border: none; padding: 10px 15px; border-radius: 20px; width: 250px; font-size: 15px; }
        .nav-icons { display: flex; gap: 10px; }
        .nav-icon { width: 40px; height: 40px; background: #e4e6eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; color: black; transition: 0.2s; font-size: 20px; }
        .nav-icon:hover { background: #d8dadf; }
        .profile-bubble { display: flex; align-items: center; gap: 8px; padding: 5px 10px; border-radius: 20px; text-decoration: none; color: black; font-weight: 600; }
        .profile-bubble:hover { background: #e4e6eb; }
        .profile-bubble img { width: 28px; height: 28px; border-radius: 50%; }

        /* Main Grid */
        .main-container { display: grid; grid-template-columns: 280px 1fr 280px; max-width: 1400px; margin: 0 auto; height: calc(100vh - 60px); }
        
        /* Left Sidebar */
        .sidebar-left { padding: 20px; overflow-y: auto; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; text-decoration: none; color: #050505; font-weight: 600; transition: 0.2s; }
        .menu-item:hover { background: #e4e6eb; }
        .menu-icon { font-size: 24px; width: 30px; text-align: center; }

        /* Feed (Center) */
        .feed-container { padding: 20px 40px; overflow-y: auto; }
        .create-post { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .post-input { width: 100%; border: none; padding: 10px; font-size: 16px; border-bottom: 1px solid #e4e6eb; outline: none; resize: none; }
        .post-actions { display: flex; justify-content: flex-end; padding-top: 10px; }
        .btn-post { background: #1877f2; color: white; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        
        .news-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .news-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; color: #65676b; }
        .news-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #050505; }
        
        /* Right Sidebar (Contacts) */
        .sidebar-right { padding: 20px; overflow-y: auto; border-left: 1px solid #e4e6eb; }
        .contacts-header { font-size: 17px; font-weight: 600; color: #65676b; margin-bottom: 15px; }
        .contact-item { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; text-decoration: none; color: #050505; font-weight: 500; transition: 0.2s; }
        .contact-item:hover { background: #e4e6eb; }
        .contact-avatar { width: 36px; height: 36px; border-radius: 50%; position: relative; }
        .online-badge { width: 10px; height: 10px; background: #31a24c; border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid white; }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar-left, .sidebar-right { display: none; }
        }
        
        /* Stories */
        .stories-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .story-card { min-width: 110px; height: 180px; position: relative; border-radius: 10px; overflow: hidden; cursor: pointer; background: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .story-card:hover { transform: scale(1.02); }
        .story-bg { width: 100%; height: 100%; object-fit: cover; }
        .story-overlay { position: absolute; top: 10px; left: 10px; width: 32px; height: 32px; border-radius: 50%; border: 3px solid #1877f2; overflow: hidden; }
        .story-overlay img { width: 100%; height: 100%; object-fit: cover; }
        .story-author { position: absolute; bottom: 10px; left: 10px; color: white; font-weight: 600; font-size: 13px; text-shadow: 0 1px 2px black; }
        
        .story-upload-card { background: white; text-align: center; display: flex; flex-direction: column; }
        .story-upload-img { height: 120px; width: 100%; object-fit: cover; }
        .story-upload-btn-container { position: relative; height: 60px; background: white; margin-top: -20px; }
        .story-upload-btn { width: 36px; height: 36px; background: #1877f2; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 3px solid white; margin: 0 auto; margin-top: -18px; }
        
        /* Modal */
        .story-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .story-modal img { max-height: 90vh; max-width: 90vw; border-radius: 8px; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }

        /* Notification Dropdown */
        .notification-dropdown { display: none; position: absolute; top: 65px; right: 15px; width: 320px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; max-height: 400px; overflow-y: auto; z-index: 200; }
        .notif-item { padding: 10px 15px; border-bottom: 1px solid #f0f2f5; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; text-decoration: none; color: black; }
        .notif-item:hover { background: #f0f2f5; }
        .notif-item.unread { background: #eaf3ff; }
        .notif-avatar { width: 40px; height: 40px; border-radius: 50%; }

        /* Story Progress Bar */
        .story-progress-container { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; gap: 5px; z-index: 1001; }
        .story-progress-bar { height: 3px; background: rgba(255,255,255,0.3); flex: 1; border-radius: 2px; overflow: hidden; }
        .story-progress-fill { height: 100%; background: white; width: 0%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .story-reactions { position: absolute; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 1002; }
        .story-react-btn { background: none; border: none; font-size: 30px; cursor: pointer; transition: 0.2s; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .story-react-btn:hover { transform: scale(1.3); }

        /* Report Modal */
        .report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .report-content { background: white; padding: 25px; border-radius: 12px; width: 400px; }
        .report-textarea { width: 100%; height: 80px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-family: inherit; }

        /* Text Story Modal */
        .story-type-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1050; justify-content: center; align-items: center; }
        .type-options { display: flex; gap: 20px; }
        .type-btn { padding: 20px 40px; background: white; border-radius: 12px; font-size: 18px; cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        .type-btn:hover { transform: scale(1.05); }

        .text-story-editor { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 1100; justify-content: center; align-items: center; flex-direction: column; }
        .editor-preview { width: 350px; height: 600px; display: flex; justify-content: center; align-items: center; padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 20px; word-wrap: break-word; font-size: 24px; color: white; font-weight: bold; }
        .color-options { display: flex; gap: 10px; margin-bottom: 20px; }
        .color-ball { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; }
        .story-textarea { width: 300px; height: 100px; margin-bottom: 20px; padding: 10px; border-radius: 8px; border: none; font-size: 16px; }

        /* Story Text Mode Display */
        .story-text-display { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; color: white; word-break: break-word; }

    </style>
</head>
<body>

    <!-- Top Navbar -->
    <div class="navbar">
        <a href="/dashboard" class="nav-logo" style="display: flex; align-items: center; gap: 2px;">
            <span style="color: #ff4757; font-weight: 800;">Bta</span>SocialPortal
        </a>
        
<form action="/search" method="GET" class="nav-search">
            <input type="text" name="q" placeholder="Search Portal...">
        </form>

        <div class="nav-icons" style="position: relative;">
            <a href="/dashboard" class="nav-icon" title="Home">üè†</a>
            <div class="nav-icon" title="Notifications" style="position:relative; cursor:pointer;" onclick="toggleNotifications()">
                üîî
                <% if (unreadNotificationsCount > 0) { %>
                    <span style="position: absolute; top: -5px; right: -5px; background: #e41e3f; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; border: 2px solid white;"><%= unreadNotificationsCount %></span>
                <% } %>
            </div>
            
            <div class="notification-dropdown" id="notificationDropdown">
                <div style="padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
                    <span>Notifications</span>
                    <a href="/notifications/read" style="font-size:12px; color:#1877f2; text-decoration:none;">Mark all read</a>
                </div>
                <% if (notifications.length === 0) { %>
                    <div style="padding: 20px; text-align: center; color: #888;">No new notifications</div>
                <% } else { %>
                    <% notifications.forEach(n => { %>
                        <div class="notif-item <%= n.read ? '' : 'unread' %>">
                            <img src="<%= n.from.avatar %>" class="notif-avatar">
                            <div>
                                <div style="font-size: 13px;">
                                    <strong><%= n.from.name %></strong> <%= n.message %>
                                </div>
                                <div style="font-size: 11px; color: #65676b;"><%= new Date(n.timestamp).toLocaleTimeString() %></div>
                            </div>
                        </div>
                    <% }) %>
                <% } %>
            </div>

            <a href="/friends" class="nav-icon" title="Friends" style="position:relative;">
                üë•
                <% if (typeof friendRequestsCount !== 'undefined' && friendRequestsCount > 0) { %>
                    <span style="position: absolute; top: -5px; right: -5px; background: #e41e3f; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; border: 2px solid white;">+<%= friendRequestsCount %></span>
                <% } %>
            </a>
            <a href="/chat" class="nav-icon" title="Messenger">üí¨</a>

            <a href="/settings" class="profile-bubble">
                <img src="<%= user.avatar || '/uploads/default.png' %>" alt="Profile">
                <%= user.firstName %>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        
        <!-- Left Sidebar: Menu -->
        <div class="sidebar-left">
            <a href="/dashboard" class="menu-item">
                <span class="menu-icon">üè†</span> ·Éõ·Éó·Éê·Éï·Éê·É†·Éò
            </a>
            <a href="/profile" class="menu-item">
                <span class="menu-icon">üë§</span> ·É©·Éî·Éõ·Éò ·Éû·É†·Éù·É§·Éò·Éö·Éò
            </a>
            <a href="/friends" class="menu-item">
                <span class="menu-icon">üë•</span> ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éî·Éë·Éò
            </a>
            <a href="/chat" class="menu-item">
                <span class="menu-icon">üí¨</span> ·Éõ·Éî·É°·Éî·Éú·ÉØ·Éî·É†·Éò
            </a>
            <a href="/news" class="menu-item">
                <span class="menu-icon">üì∞</span> ·É°·Éò·Éê·ÉÆ·Éö·Éî·Éî·Éë·Éò
            </a>
            <hr style="border: 0; border-top: 1px solid #ced0d4; margin: 10px 0;">
            <a href="/settings" class="menu-item">
                <span class="menu-icon">‚öôÔ∏è</span> ·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éî·Éë·Éò
            </a>
            <a href="/logout" class="menu-item" style="color: #d63031;">
                <span class="menu-icon">üö™</span> ·Éí·Éê·É°·Éï·Éö·Éê
            </a>
        </div>

        <!-- Center: Feed -->
        <div class="feed-container">
            
            <!-- Stories Section -->
            <div class="stories-container">
                <!-- My Story / Upload -->
                <div class="story-card story-upload-card" onclick="openStoryTypeModal()">
                    <img src="<%= user.avatar || '/uploads/default.png' %>" class="story-upload-img" style="filter: brightness(0.8);">
                    <div class="story-upload-btn-container">
                        <div class="story-upload-btn">+</div>
                        <div style="font-size: 12px; font-weight: 600; margin-top: 5px;">Create Story</div>
                    </div>
                </div>
                
                <!-- Hidden Forms -->
                <form action="/stories/create" method="POST" enctype="multipart/form-data" id="photoStoryForm">
                    <input type="file" name="image" id="storyInput" accept="image/*" style="display: none;" onchange="document.getElementById('photoStoryForm').submit()">
                </form>

                <form action="/stories/create" method="POST" enctype="multipart/form-data" id="textStoryForm" style="display:none;">
                    <textarea name="text" id="hiddenStoryText"></textarea>
                    <input type="text" name="background" id="hiddenStoryBg">
                </form>


                <!-- Active Stories -->
                <% Object.keys(stories).forEach(userId => { 
                    const data = stories[userId];
                    const latestStory = data.stories[data.stories.length - 1]; 
                    // Pass all stories for this user to the modal logic
                    const userStories = JSON.stringify(data.stories);
                %>
                    <div class="story-card" onclick='openStoryGroup(<%- userStories %>, "<%= userId %>")'>
                        <% if (latestStory.image) { %>
                             <img src="<%= latestStory.image %>" class="story-bg">
                        <% } else { %>
                             <div class="story-bg" style="background: <%= latestStory.background %>; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; padding: 10px; text-align: center; font-size: 14px;">
                                 <%= latestStory.text.length > 50 ? latestStory.text.substring(0, 50) + '...' : latestStory.text %>
                             </div>
                        <% } %>
                        <div class="story-overlay">
                            <img src="<%= data.authorAvatar %>">
                        </div>
                        <div class="story-author"><%= data.authorName %></div>
                    </div>
                <% }) %>
            </div>

            <div class="create-post">
                <form action="/posts/create" method="POST" enctype="multipart/form-data">
                    <div style="display: flex; gap: 10px;">
                        <img src="<%= user.avatar || '/uploads/default.png' %>" style="width: 40px; height: 40px; border-radius: 50%;">
                        <textarea name="content" class="post-input" rows="3" placeholder="·É†·Éê ·Éê·É†·Éò·É° ·Éê·ÉÆ·Éê·Éö·Éò, <%= user.firstName %>?"></textarea>
                    </div>
                    <div class="post-actions">
                         <label for="post-image" style="cursor: pointer; margin-right: 15px; color: #1877f2; display: flex; align-items: center; gap: 5px;">
                            üì∑ ·É§·Éù·É¢·Éù·É° ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê
                            <input type="file" name="image" id="post-image" accept="image/*" style="display: none;">
                        </label>
                        <button type="button" onclick="toggleFeelingModal()" style="background:none; border:none; cursor:pointer; color:#f7b928; margin-right:auto; display:flex; align-items:center; gap:5px; font-weight:600;">
                            üôÇ Feeling/Activity
                        </button>
                        <input type="hidden" name="feeling" id="uFeeling">
                        <input type="hidden" name="feelingIcon" id="uFeelingIcon">
                        <div id="selectedFeelingDisplay" style="display:none; font-size:12px; align-items:center; gap:5px; background:#f0f2f5; padding:4px 8px; border-radius:10px; margin-right:10px;"></div>

                        <select name="privacy" style="margin-right: 10px; padding: 5px; border-radius: 5px; border: 1px solid #ddd; outline: none; background: #f0f2f5; cursor: pointer;">
                            <option value="public">üåé Public</option>
                            <option value="friends">üë• Friends</option>
                        </select>
                        <button type="submit" class="btn-post">·Éì·Éê·Éû·Éù·É°·É¢·Éï·Éê</button>
                    </div>
                </form>
            </div>

            <!-- Feeling Modal -->
            <div id="feelingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
                <div style="background:white; width:350px; border-radius:10px; overflow:hidden;">
                     <div style="padding:15px; border-bottom:1px solid #ddd; font-weight:bold; display:flex; justify-content:space-between;">
                         <span>How are you feeling?</span>
                         <span onclick="toggleFeelingModal()" style="cursor:pointer;">‚úñ</span>
                     </div>
                     <div style="max-height:400px; overflow-y:auto;">
                         <% 
                           const feelings = [
                             { icon: 'üôÇ', text: 'Happy' },
                             { icon: 'ü•∞', text: 'Loved' },
                             { icon: 'üòî', text: 'Sad' },
                             { icon: 'ü§©', text: 'Excited' },
                             { icon: 'üòú', text: 'Crazy' },
                             { icon: 'üò¥', text: 'Tired' },
                             { icon: 'üò°', text: 'Angry' },
                             { icon: 'ü§í', text: 'Sick' },
                             { icon: 'ü•≥', text: 'Celebrating' },
                             { icon: 'üçî', text: 'Eating' },
                             { icon: 'üì∫', text: 'Watching' },
                             { icon: '‚úàÔ∏è', text: 'Traveling' }
                           ];
                         %>
                         <% feelings.forEach(f => { %>
                             <div onclick="selectFeeling('<%= f.text %>', '<%= f.icon %>')" style="padding:10px 15px; display:flex; gap:10px; cursor:pointer; hover:background:#f0f2f5;">
                                 <span style="font-size:20px;"><%= f.icon %></span>
                                 <span><%= f.text %></span>
                             </div>
                         <% }) %>
                     </div>
                </div>
            </div>

            <script>
                function toggleFeelingModal() {
                    const el = document.getElementById('feelingModal');
                    el.style.display = el.style.display === 'none' ? 'flex' : 'none';
                }
                function selectFeeling(text, icon) {
                    document.getElementById('uFeeling').value = text;
                    document.getElementById('uFeelingIcon').value = icon;
                    const disp = document.getElementById('selectedFeelingDisplay');
                    disp.style.display = 'flex';
                    disp.innerHTML = icon + ' ' + text + ' <span onclick="clearFeeling()" style="cursor:pointer; margin-left:5px;">‚úñ</span>';
                    toggleFeelingModal();
                }
                function clearFeeling() {
                    document.getElementById('uFeeling').value = '';
                    document.getElementById('uFeelingIcon').value = '';
                    document.getElementById('selectedFeelingDisplay').style.display = 'none';
                }
            </script>

            <% if (news.length === 0) { %>
                <div style="text-align: center; color: #65676b; margin-top: 50px;">
                    <h3>·É°·Éò·Éê·ÉÆ·Éö·Éî·Éî·Éë·Éò ·ÉØ·Éî·É† ·Éê·É† ·Éê·É†·Éò·É°</h3>
                    <p>·Éì·Éê·Éê·Éõ·Éê·É¢·Éî·Éó ·Éõ·Éî·Éí·Éù·Éë·É†·Éî·Éë·Éò ·É†·Éù·Éõ ·Éú·Éê·ÉÆ·Éù·Éó ·Éõ·Éê·Éó·Éò ·É°·Éò·Éê·ÉÆ·Éö·Éî·Éî·Éë·Éò</p>
                </div>
            <% } %>

            <% news.forEach(item => { %>
                <div class="news-card">
                    <div class="news-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <a href="/user/<%= item.userId %>" style="text-decoration: none;">
                                <img src="<%= item.authorAvatar %>" style="width: 40px; height: 40px; border-radius: 50%;">
                            </a>
                            <div>
                                <strong style="display: block; color: #050505;">
                                    <a href="/user/<%= item.userId %>" style="color: #050505; text-decoration: none; hover:underline;"><%= item.authorName %></a>
                                    <% if (item.feeling) { %>
                                        <span style="font-weight:normal; color:#65676b;">is feeling <%= item.feelingIcon %> <%= item.feeling %></span>
                                    <% } %>
                                </strong>
                                <span style="font-size: 12px; color: #65676b;">
                                    <%= new Date(item.timestamp).toLocaleString('ka-GE') %> ‚Ä¢ 
                                    <span title="<%= item.privacy === 'friends' ? 'Friends' : 'Public' %>">
                                        <%= item.privacy === 'friends' ? 'üë•' : 'üåé' %>
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <% if (item.content) { %>
                        <div style="font-size: 15px; line-height: 1.5; margin-bottom: 10px;"><%= item.content %></div>
                    <% } %>
                    <% if (item.image) { %>
                        <div style="margin-top: 10px;">
                            <img src="<%= item.image %>" style="width: 100%; border-radius: 8px;">
                        </div>
                    <% } %>
                    
                    <div style="border-top: 1px solid #e4e6eb; margin-top: 10px; padding-top: 10px;">
                        <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                            <form action="/post/like/<%= item.id %>" method="POST" style="display:inline;">
                                <% const isLiked = item.likes && item.likes.includes(user.email); %>
                                <button type="submit" style="background: none; border: none; font-weight: 600; color: <%= isLiked ? '#1877f2' : '#65676b' %>; cursor: pointer;">
                                    <%= isLiked ? 'üëç Liked' : 'üëç Like' %> (<%= item.likes ? item.likes.length : 0 %>)
                                </button>
                            </form>
                            <button onclick="document.getElementById('comment-box-<%= item.id %>').focus()" style="background: none; border: none; font-weight: 600; color: #65676b; cursor: pointer;">üí¨ Comment</button>
                            
                            <% if (item.userId === user.email) { %>
                                <button onclick="confirmDelete('post', '<%= item.id %>')" style="background: none; border: none; font-weight: 600; color: #e41e3f; cursor: pointer; margin-left: auto;">üóëÔ∏è Delete</button>
                            <% } else { %>
                                <button onclick="openReport('post', '<%= item.id %>')" style="background: none; border: none; font-weight: 600; color: #65676b; cursor: pointer; margin-left: auto;">üö© Report</button>
                            <% } %>
                        </div>

                        <!-- Comments Section -->
                        <% if (item.comments && item.comments.length > 0) { %>
                            <div style="background: #f0f2f5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <% item.comments.forEach(comment => { %>
                                    <div style="font-size: 13px; margin-bottom: 5px;">
                                        <strong>
                                            <a href="/user/<%= comment.authorEmail %>" style="color: #050505; text-decoration: none; hover:underline;">
                                                <%= comment.authorName %>
                                            </a>:
                                        </strong> 
                                        <%= comment.text %>
                                    </div>
                                <% }) %>
                            </div>
                        <% } %>

                        <form action="/post/comment/<%= item.id %>" method="POST" style="display: flex; gap: 5px;">
                            <input type="text" name="comment" id="comment-box-<%= item.id %>" placeholder="·Éì·Éê·É¨·Éî·É†·Éî·Éó ·Éô·Éù·Éõ·Éî·Éú·É¢·Éê·É†·Éò..." style="flex: 1; border: 1px solid #ccc; border-radius: 20px; padding: 5px 10px; outline: none;">
                            <button type="submit" style="border: none; background: none; color: #1877f2; cursor: pointer; font-weight: bold;">SEND</button>
                        </form>
                    </div>
                </div>
            <% }) %>
        </div>

        <!-- Right Sidebar: Contacts -->
        <div class="sidebar-right">
            <div class="contacts-header">·Éô·Éù·Éú·É¢·Éê·É•·É¢·Éî·Éë·Éò</div>
            
            <% contacts.forEach(c => { %>
                <% if (c.email !== user.email) { %>
                    <div onclick="openChat('<%= c.email %>', '<%= c.firstName %> <%= c.lastName %>', '<%= c.avatar %>')" class="contact-item" style="cursor: pointer;">
                        <div class="contact-avatar">
                            <img src="<%= c.avatar %>" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            <div class="online-badge" id="status-<%= c.email %>" style="display:none;"></div>
                        </div>
                        <span><%= c.firstName %> <%= c.lastName %></span>
                    </div>
                <% } %>
            <% }) %>
        </div>

    </div>

    </div>

    <!-- Story Viewer Modal -->
    <div class="story-modal" id="storyModal">
        <span class="close-modal" onclick="closeStory()">&times;</span>
        
        <div class="story-progress-container" id="storyProgressContainer"></div>

        <div id="storyContentContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <img id="storyModalImg" src="" style="display: none; max-height: 90vh; max-width: 90vw; border-radius: 8px;">
            <div id="storyModalText" class="story-text-display" style="display: none;"></div>
        </div>
        
        <div class="story-reactions">
            <button class="story-react-btn" onclick="reactToStory('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button class="story-react-btn" onclick="reactToStory('üòÇ')">üòÇ</button>
            <button class="story-react-btn" onclick="reactToStory('üòÆ')">üòÆ</button>
            <button class="story-react-btn" onclick="reactToStory('üò¢')">üò¢</button>
            <button class="story-react-btn" onclick="reactToStory('üò°')">üò°</button>
        </div>
        <button id="storyDeleteBtn" style="display:none; position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.5); color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; z-index:1001;" onclick="deleteCurrentStory()">üóëÔ∏è</button>
    </div>

    <!-- Report Modal -->
    <div class="report-modal" id="reportModal">
        <div class="report-content">
            <h3>Report Content</h3>
            <form id="reportForm" method="POST">
                <input type="hidden" name="type" id="reportType">
                <textarea name="reason" class="report-textarea" placeholder="Why are you reporting this?"></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" onclick="document.getElementById('reportModal').style.display='none'" style="padding: 8px 15px; border: none; background: #ddd; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 8px 15px; border: none; background: #e41e3f; color: white; border-radius: 6px; cursor: pointer;">Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Type Selection Modal -->
    <div class="story-type-modal" id="storyTypeModal">
        <span class="close-modal" onclick="closeStoryTypeModal()">&times;</span>
        <div class="type-options">
            <button class="type-btn" onclick="startPhotoStory()">üì∑ Photo</button>
            <button class="type-btn" onclick="startTextStory()">üìù Text</button>
        </div>
    </div>

    <!-- Text Story Editor -->
    <div class="text-story-editor" id="textStoryEditor">
        <span class="close-modal" onclick="closeTextEditor()">&times;</span>
        
        <div class="editor-preview" id="editorPreview" style="background: linear-gradient(45deg, #FF512F, #DD2476);">
            Type something...
        </div>

        <div class="color-options">
            <div class="color-ball" style="background: linear-gradient(45deg, #FF512F, #DD2476);" onclick="setBg('linear-gradient(45deg, #FF512F, #DD2476)')"></div>
            <div class="color-ball" style="background: linear-gradient(45deg, #2193b0, #6dd5ed);" onclick="setBg('linear-gradient(45deg, #2193b0, #6dd5ed)')"></div>
            <div class="color-ball" style="background: linear-gradient(45deg, #cc2b5e, #753a88);" onclick="setBg('linear-gradient(45deg, #cc2b5e, #753a88)')"></div>
            <div class="color-ball" style="background: linear-gradient(45deg, #11998e, #38ef7d);" onclick="setBg('linear-gradient(45deg, #11998e, #38ef7d)')"></div>
            <div class="color-ball" style="background: #333;" onclick="setBg('#333')"></div>
        </div>

        <textarea class="story-textarea" id="storyTextInput" placeholder="Whats on your mind?" oninput="updatePreview(this.value)"></textarea>

        <button class="type-btn" style="background: #1877f2; color: white;" onclick="submitTextStory()">Share to Story</button>
    </div>

    <!-- Chat Popup -->
    <div id="chatPopup" style="display:none; position:fixed; bottom:0; right:20px; width:300px; height:400px; background:white; border-radius:8px 8px 0 0; box-shadow:0 -2px 10px rgba(0,0,0,0.1); z-index:5000; flex-direction:column; overflow:hidden;">
        <!-- Header -->
        <div style="background:#1877f2; padding:10px; color:white; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
             <div style="display:flex; align-items:center; gap:8px;">
                 <img id="chatPopupAvatar" src="" style="width:24px; height:24px; border-radius:50%;">
                 <span id="chatPopupName">User</span>
             </div>
             <div onclick="closeChatPopup()" style="cursor:pointer; font-size:18px;">‚úñ</div>
        </div>
        
        <!-- Messages Area -->
        <div id="chatPopupMessages" style="flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; background:#f0f2f5;">
            <!-- Js will populate this -->
        </div>

        <!-- Input Area -->
        <div style="padding:10px; border-top:1px solid #ddd; background:white; display:flex; gap:5px;">
             <input type="text" id="chatPopupInput" placeholder="Aa" style="flex:1; border:none; outline:none; background:#f0f2f5; padding:8px 12px; border-radius:20px;">
             <button onclick="sendPopupMessage()" style="background:none; border:none; color:#1877f2; cursor:pointer; font-size:20px;">‚û§</button>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:6000; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:8px; width:300px; text-align:center;">
             <h3>Delete this?</h3>
             <p>Are you sure you want to delete this content?</p>
             <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
                 <button onclick="closeDeleteModal()" style="padding:8px 15px; border:none; background:#ddd; border-radius:5px; cursor:pointer;">Cancel</button>
                 <button id="confirmDeleteBtn" style="padding:8px 15px; border:none; background:#e41e3f; color:white; border-radius:5px; cursor:pointer;">Delete</button>
             </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const userEmail = "<%= user.email %>";
        let activeChatUser = null; // Email of the user currently in the popup
        
        socket.emit('user_connected', userEmail);

        socket.on('online_users', (users) => {
            document.querySelectorAll('.online-badge').forEach(el => el.style.display = 'none');
            users.forEach(email => {
                const el = document.getElementById('status-' + email);
                if (el) el.style.display = 'block';
            });
        });

        // Chat Popup Logic
        function openChat(email, name, avatar) {
            activeChatUser = email;
            document.getElementById('chatPopup').style.display = 'flex';
            document.getElementById('chatPopupName').innerText = name;
            document.getElementById('chatPopupAvatar').src = avatar;
            document.getElementById('chatPopupMessages').innerHTML = '<div style="text-align:center; color:#888;">Loading...</div>';

            fetch(`/api/chat/history/${email}`)
            .then(res => res.json())
            .then(msgs => {
                const container = document.getElementById('chatPopupMessages');
                container.innerHTML = '';
                msgs.forEach(m => appendPopupMessage(m));
                scrollToBottom();
            });
        }

        function closeChatPopup() {
            document.getElementById('chatPopup').style.display = 'none';
            activeChatUser = null;
        }

        function sendPopupMessage() {
            const input = document.getElementById('chatPopupInput');
            const msg = input.value.trim();
            if (!msg || !activeChatUser) return;

            // Emit to socket
            socket.emit('chat message', {
               to: activeChatUser,
               msg: msg,
               from: userEmail
            });

            // Optimistically append
            appendPopupMessage({
                from: userEmail,
                message: msg,
                timestamp: new Date().toISOString()
            });

            input.value = '';
            scrollToBottom();
        }

        socket.on('chat message', (data) => {
            if (activeChatUser && (data.from === activeChatUser || data.from === userEmail)) {
                 appendPopupMessage({
                     from: data.from,
                     message: data.msg,
                     timestamp: new Date().toISOString()
                 });
                 scrollToBottom();
            } else {
                // Play sound or show badge if minimized/other user
            }
        });

        function appendPopupMessage(data) {
            const isMe = data.from === userEmail;
            const div = document.createElement('div');
            div.style.alignSelf = isMe ? 'flex-end' : 'flex-start';
            div.style.background = isMe ? '#1877f2' : 'white';
            div.style.color = isMe ? 'white' : 'black';
            div.style.padding = '8px 12px';
            div.style.borderRadius = '15px';
            div.style.fontSize = '14px';
            div.style.maxWidth = '70%';
            div.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
            div.innerText = data.message;
            document.getElementById('chatPopupMessages').appendChild(div);
        }

        function scrollToBottom() {
            const el = document.getElementById('chatPopupMessages');
            el.scrollTop = el.scrollHeight;
        }

        // Enter key to send
        document.getElementById('chatPopupInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendPopupMessage();
        });


        // Notifications
        function toggleNotifications() {
            const el = document.getElementById('notificationDropdown');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }
        
        // Report Logic
        function openReport(type, id) {
            document.getElementById('reportType').value = type;
            document.getElementById('reportForm').action = "/report/" + id;
            document.getElementById('reportModal').style.display = 'flex';
        }

        // --- AUTHOR DELETE LOGIC ---
        function confirmDelete(type, id) {
            const modal = document.getElementById('deleteModal');
            const btn = document.getElementById('confirmDeleteBtn');
            modal.style.display = 'flex';
            
            btn.onclick = function() {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/${type}/delete/${id}`;
                document.body.appendChild(form);
                form.submit();
            };
        }
        function closeDeleteModal() {
             document.getElementById('deleteModal').style.display = 'none';
        }


        // Story Logic
        let currentStories = [];
        let currentStoryIndex = 0;
        let storyTimer;
        let progressInterval;
        const STORY_DURATION = 5000; // 5 seconds
        
        function openStoryGroup(stories, userId) {
            currentStories = stories;
            currentStoryIndex = 0;
            document.getElementById('storyModal').style.display = 'flex';
            showStory();
        }

        // Text Story Logic
        let currentBg = 'linear-gradient(45deg, #FF512F, #DD2476)';

        function openStoryTypeModal() {
            document.getElementById('storyTypeModal').style.display = 'flex';
        }
        function closeStoryTypeModal() {
            document.getElementById('storyTypeModal').style.display = 'none';
        }
        
        function startPhotoStory() {
            closeStoryTypeModal();
            document.getElementById('storyInput').click();
        }

        function startTextStory() {
            closeStoryTypeModal();
            document.getElementById('textStoryEditor').style.display = 'flex';
        }
        function closeTextEditor() {
            document.getElementById('textStoryEditor').style.display = 'none';
        }

        function setBg(bg) {
            currentBg = bg;
            document.getElementById('editorPreview').style.background = bg;
        }

        function updatePreview(text) {
            document.getElementById('editorPreview').innerText = text || "Type something...";
        }

        function submitTextStory() {
            const text = document.getElementById('storyTextInput').value;
            if (!text.trim()) return alert("Please enter text");
            
            document.getElementById('hiddenStoryText').value = text;
            document.getElementById('hiddenStoryBg').value = currentBg;
            document.getElementById('textStoryForm').submit();
        }

        // Updated Show Logic
        function showStory() {
            if (currentStoryIndex >= currentStories.length) {
                closeStory();
                return;
            }
            
            const story = currentStories[currentStoryIndex];
            const imgEl = document.getElementById('storyModalImg');
            const textEl = document.getElementById('storyModalText');

            if (story.image) {
                imgEl.src = story.image;
                imgEl.style.display = 'block';
                textEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                textEl.innerText = story.text;
                textEl.style.background = story.background;
                textEl.style.display = 'flex';
            }
            
            renderProgressBars();
            startProgress(currentStoryIndex);

            // Auto switch
            clearTimeout(storyTimer);
            storyTimer = setTimeout(() => {
                nextStory();
            }, STORY_DURATION);

            // Show Delete Button if Owner
            const delBtn = document.getElementById('storyDeleteBtn');
            if (story.userId === userEmail) {
                delBtn.style.display = 'block';
            } else {
                delBtn.style.display = 'none';
            }
        }
        
        function deleteCurrentStory() {
            const story = currentStories[currentStoryIndex];
            if (story) {
                confirmDelete('story', story.id);
            }
        }

        function nextStory() {
            currentStoryIndex++;
            showStory();
        }

        function closeStory() {
            document.getElementById('storyModal').style.display = 'none';
            clearTimeout(storyTimer);
            clearInterval(progressInterval);
        }

        function renderProgressBars() {
            const container = document.getElementById('storyProgressContainer');
            container.innerHTML = '';
            
            currentStories.forEach((s, idx) => {
                const bar = document.createElement('div');
                bar.className = 'story-progress-bar';
                const fill = document.createElement('div');
                fill.className = 'story-progress-fill';
                
                if (idx < currentStoryIndex) fill.style.width = '100%';
                else if (idx > currentStoryIndex) fill.style.width = '0%';
                else fill.id = 'activeProgress';
                
                bar.appendChild(fill);
                container.appendChild(bar);
            });
        }

        function startProgress() {
            clearInterval(progressInterval);
            const activeFill = document.getElementById('activeProgress');
            if (!activeFill) return;
            
            let startTime = Date.now();
            progressInterval = setInterval(() => {
                let elapsed = Date.now() - startTime;
                let pct = (elapsed / STORY_DURATION) * 100;
                if (pct > 100) pct = 100;
                activeFill.style.width = pct + '%';
            }, 50);
        }

        function reactToStory(emoji) {
            const story = currentStories[currentStoryIndex];
            fetch('/story/react/' + story.id, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reaction: emoji })
            });
            
            // Show simple animation
            const btn = event.target;
            btn.style.transform = "scale(2)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);
        }

    </script>

</body>
</html>
